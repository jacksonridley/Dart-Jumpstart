<html lang="en-us">
    <head>
        <title>Dart Jumpstart</title>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    </head>

    <body>
        <script>
            
            var config = {
                type: Phaser.AUTO,
                width: 1200,
                height: 700,
                physics: {
                    default: "arcade"
                },

                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            class Player extends Phaser.Physics.Arcade.Sprite 
            {
                animations;
                isJumping;
                constructor(scene, x, y, spritesheet, animations)
                {
                    super(scene, x, y, spritesheet);
                    this.animations = animations;
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(2);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(1000); 
                    this.isJumping = false;
                }
            }
            class Enemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "enemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(0.25);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }

            var game = new Phaser.Game(config);

            //Game Objects
            var platforms;
            var player;
            var enemy;
            var enemySpeed = 100;
            var enemyTicks = 0;
            var tickAmount = 1;
            var lifePoints = 3;
            var invincibility = false;
            //Keyboard controls
            var cursors;
            var keys;
            var space;

            var gui;
            var guiTimer;


            function preload() {
                this.load.image("sky", "assets/clouds.png");
                this.load.image("platform", "assets/platform.png");
                this.load.image("enemy", "assets/pikachu.png");
                this.load.atlas('player', 'assets/playersheet.png', 'assets/playersheet.json');
            }

            function create() {
                //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
                let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, "sky").setOrigin(0, 0);

                //Create the platforms and the player character set to collide with the platforms
                createPlatforms(this);
                //creates an enemy
                enemy = new Enemy(this, 900, 350);
                //adds collision for enemy with platforms
                this.physics.add.collider(enemy, platforms);

                //set up animations for player
                let playerAnimations = {};
                var idle = this.anims.create({key: 'sprite_idle', frames: this.anims.generateFrameNames('player', {prefix: 'sprite_idle', end: 1, zeroPad: 1}), repeat: -1, frameRate: 2});
                playerAnimations['idle'] = idle
                var right = this.anims.create({key: 'sprite_right', frames: this.anims.generateFrameNames('player', {prefix: 'sprite_right', end: 1, zeroPad: 1}), repeat: -1, frameRate: 2});
                playerAnimations['right'] = right;
                var up = this.anims.create({key: 'sprite_jump', frames: this.anims.generateFrameNames('player', {prefix: 'sprite_jump', end: 2, zeroPad: 1}), repeat: 1, frameRate: 4});
                playerAnimations['up'] = up;
                var fall = this.anims.create({key: 'sprite_idle', frames: this.anims.generateFrameNames('player', {prefix: 'sprite_idle', end: 1, zeroPad: 1}), repeat: -1, frameRate: 2});
                playerAnimations['fall'] = fall;

                //initialize player object w/ collision w platforms
                player = new Player(this, 400, 500, 'player', playerAnimations);
                this.physics.add.collider(player, platforms);
                player.play(player.animations['idle']);

                //Set up user input
                cursors = this.input.keyboard.createCursorKeys();
                keys = this.input.keyboard.addKeys("A, D");
                space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                space.on("down", jump); //calls jump function when space is pressed

                gui = this.add.text(150, 300, "", { fontSize: "160px", fill: "#ff0000" });
                enemy.setVelocityX(enemySpeed);
                this.physics.add.overlap(player, enemy, dmgPlayer, null, this);

            }

            function createPlatforms(scene) {
                platforms = scene.physics.add.staticGroup();

                //basePlatform is the floor of the game
                let basePlatform = platforms.create(game.scale.width / 2, game.scale.height - 30, "platform");
                basePlatform.setScale(3, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor

                platforms.create(250, 350, "platform"); //creates the upper left platform
                platforms.create(950, 500, "platform"); //creates the bottom right platform
            }

            function update() {

                //Player has "drag" on the x-axis meaning they slide a bit after an input
                player.setDragX(1000);

                if (player.body.touching.down && player.isJumping) 
                {
                    player.isJumping = false;
                }

                //if player is jumping and velocity is 0, set to fall animation
                if (player.isJumping && player.body.velocity.y >= 0){
                    player.play(player.animations['fall'], true);
                    console.log("done");
                }

                //Handle player movements
                if (cursors.left.isDown || keys.A.isDown)
                {
                    player.setVelocityX(-200);
                    player.flipX=true;
                    if (!player.isJumping) {
                        player.play(player.animations['right'], true);
                    }
                } else if (cursors.right.isDown || keys.D.isDown)
                {
                    player.setVelocityX(200);
                    player.flipX=false;
                    if (!player.isJumping) {
                    player.play(player.animations['right'], true);
                    }
                } 

                else 
                {
                    if (!player.isJumping) {
                        player.play(player.animations['idle'], true);
                    }
                }
                //Timer for enemy turns, and turns them around
                basicEnemyMove(enemy, enemySpeed, 101);
                //Checks if player has enough health to continue play, if not, the player is deleted
                
            }

            function jump(event) {
                if (player.body.touching.down)
                {
                    player.isJumping = true;
                    player.play(player.animations['up'], true);
                    player.setVelocityY(-700);
                }
            }

            function dmgPlayer(player, enemy) {
                
                lifePoints--;
                if(lifePoints === 0){
                    player.disableBody(true, true);
                }
 
            }
            function basicEnemyMove(enemy, speed, length) {
                enemyTicks += tickAmount;
                if (enemyTicks === length) {
                    enemy.setVelocityX(-speed);
                    tickAmount = -1;
                } else if (enemyTicks === -1) {
                    enemy.setVelocityX(speed);
                    tickAmount = 1;
                }
            
            }
            
           //testing comment

            //Reset the gui text to be empty after the guiTimer elapses
            function removeText() {
                gui.setText("");
            }
        </script>
    </body>
</html>