<html lang="en-us">
    <head>
        <title>Dart Jumpstart</title>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    </head>

    <body>
        <script>
            var config = {
                type: Phaser.AUTO,
                width: 480*3,
                height: 320*3,
                physics: {
                    default: "arcade"
                },

                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            class Player extends Phaser.Physics.Arcade.Sprite {
                animations;
                isJumping;
                constructor(scene, x, y, spritesheet, animations) {
                    super(scene, x, y, spritesheet);
                    this.animations = animations;
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(2);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(1000);
                    this.isJumping = false;
                }
            }
            class CloudEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "cloudEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(0.25);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(0);
                }
            }
            class MeleeEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "meleeEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }
            class RangedEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "rangedEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }
            class BatEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "batEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(0);
                }
            }
            class CyclopsEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "cyclopsEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }

            var game = new Phaser.Game(config);
            //tiles
            var background;
            var fences;
            var bush0;
            var trees;
            var bush1;
            var ground;
            var map;

            var isColliding;

            //Game Objects
            var platforms;
            var player;
            var enemy;
            var cloudSpeed = 100;
            var enemyTicks = 0;
            var tickAmount = 1;
            var lifePoints = 3;
            var invincibility = false;
            var invinCount = 0;
            //Keyboard controls
            var cursors;
            var keys;
            var space;

            var gui;
            var guiTimer;

            function preload() {
                this.load.image("sky", "assets/clouds.png");
                this.load.image("platform", "assets/platform.png");
                this.load.image("enemy", "assets/pikachu.png");
                this.load.atlas("player", "assets/playersheet.png", "assets/playersheet.json");
                this.load.atlas('player', 'assets/playersheet.png', 'assets/playersheet.json');
                this.load.image('tiles', 'assets/world_tileset.png');
                this.load.tilemapTiledJSON('map', 'assets/map.json');
            }

            function create() {
                // create the Tilemap
                map = this.make.tilemap({ key: 'map' });
                // add the tileset image we are using (CHECK THIS!)
                var tileset = map.addTilesetImage('tileset', 'tiles');
                // create the layers we want in the right order
                background = map.createLayer('background', tileset, 0, 0);
                fences = map.createLayer('fences', tileset, 0, 0);
                bush0=map.createLayer('bush_0', tileset, 0, 0);
                trees=map.createLayer('trees', tileset, 0, 0);
                bush1=map.createLayer('bush_1', tileset, 0, 0);
                ground=map.createLayer('platforms', tileset, 0, 0);

                background.setScale(3);
                fences.setScale(3);
                bush0.setScale(3);
                trees.setScale(3);
                bush1.setScale(3);
                ground.setScale(3);

                ground.setCollisionByProperty({collides:true});

                //creates an enemy
                enemy = new CloudEnemy(this, 450, 450);

                //set up animations for player
                let playerAnimations = {};
                var idle = this.anims.create({
                    key: "sprite_idle",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_idle", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["idle"] = idle;
                var right = this.anims.create({
                    key: "sprite_right",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_right", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["right"] = right;
                var up = this.anims.create({
                    key: "sprite_jump",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_jump", end: 2, zeroPad: 1 }),
                    repeat: 1,
                    frameRate: 4
                });
                playerAnimations["up"] = up;
                var fall = this.anims.create({
                    key: "sprite_idle",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_idle", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["fall"] = fall;

                //initialize player object w/ collision w platforms
                player = new Player(this, 100, 600, "player", playerAnimations);
                this.physics.add.collider(player, ground);
                player.play(player.animations["idle"]);

                //Set up user input
                cursors = this.input.keyboard.createCursorKeys();
                keys = this.input.keyboard.addKeys("A, D");
                space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                space.on("down", jump); //calls jump function when space is pressed

                gui = this.add.text(15, 15, "", { fontSize: "30px", fill: "#ff0000" });
                enemy.setVelocityX(cloudSpeed);
                this.physics.add.overlap(player, enemy, dmgPlayer, null, this);
                graphics = this.add.graphics();
            }

            function createPlatforms(scene) {
                platforms = scene.physics.add.staticGroup();

                //basePlatform is the floor of the game
                let basePlatform = platforms.create(game.scale.width / 2, game.scale.height - 30, "platform");
                basePlatform.setScale(3, 1).refreshBody(); //scales the base platform in the x axis to cover the entire floor
            }

            function update() {
                isColliding = this.physics.overlap(player, ground);
                gui.setText("Health: " + lifePoints);
                

                //Player has "drag" on the x-axis meaning they slide a bit after an input
                player.setDragX(1000);

                if (isColliding && player.isJumping) {
                    player.isJumping = false;
                }

                //if player is jumping and velocity is 0, set to fall animation
                if (player.isJumping && player.body.velocity.y >= 0) {
                    player.play(player.animations["fall"], true);
                    console.log("done");
                }

                //Handle player movements
                if (cursors.left.isDown || keys.A.isDown) {
                    player.setVelocityX(-200);
                    player.flipX = true;
                    if (!player.isJumping) {
                        player.play(player.animations["right"], true);
                    }
                } else if (cursors.right.isDown || keys.D.isDown) {
                    player.setVelocityX(200);
                    player.flipX = false;
                    if (!player.isJumping) {
                        player.play(player.animations["right"], true);
                    }
                } else {
                    if (!player.isJumping) {
                        player.play(player.animations["idle"], true);
                    }
                }
                //If player is invincible, starts a countdown to when they will become vulnerable again
                if (invincibility) {
                    invinCount++;
                    if (invinCount === 75) {
                        invincibility = !invincibility;
                        invinCount = 0;
                    }
                }
            }

            function jump(event) {
                if (isColliding) {
                    player.isJumping = true;
                    player.play(player.animations["up"], true);
                    player.setVelocityY(-500);
                }
            }

            function dmgPlayer(player, enemy) {
                if (!invincibility) {
                    lifePoints--;
                    invincibility = !invincibility;
                }

                if (lifePoints === 0) {
                    player.disableBody(true, true);
                }
            }
            function basicEnemyMove(enemy, speed, length) {
                enemyTicks += tickAmount;
                if (enemyTicks === length) {
                    enemy.setVelocityX(-speed);
                    tickAmount = -1;
                } else if (enemyTicks === -1) {
                    enemy.setVelocityX(speed);
                    tickAmount = 1;
                }
            }

            //Reset the gui text to be empty after the guiTimer elapses
            function removeText() {
                gui.setText("");
            }
        </script>
    </body>
</html>
