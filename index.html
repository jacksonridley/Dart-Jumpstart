<html lang="en-us">
    <head>
        <title>Dart Jumpstart</title>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #game-container {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        </style>
    </head>

    <body>
        <script>
            const config = {
                type: Phaser.AUTO,
                width: 1200,
                height:800,
                physics: {
                    default: "arcade",
                    arcade: {
                        gravity: { y: 550 },
                        debug: false
                    }
                },

                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            class Player extends Phaser.Physics.Arcade.Sprite {
                animations;
                isJumping;
                constructor(scene, x, y, spritesheet, animations) {
                    super(scene, x, y, spritesheet);
                    this.animations = animations;
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(2);
                    this.setCollideWorldBounds(false);
                    this.setGravityY(1000);
                    this.isJumping = false;
                }
            }
            class CloudEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "cloudEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(0.1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(0);
                }
            }
            class MeleeEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "meleeEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(3);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }
            class RangedEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "rangedEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }
            class BatEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "batEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(0);
                }
            }
            class CyclopsEnemy extends Phaser.Physics.Arcade.Sprite {
                constructor(scene, x, y) {
                    super(scene, x, y, "cyclopsEnemy");
                    scene.add.existing(this);
                    scene.physics.add.existing(this);
                    this.setScale(1);
                    this.setCollideWorldBounds(true);
                    this.setGravityY(3000);
                }
            }

            const game = new Phaser.Game(config);

            //Game Objects
            let platforms;
            let player;
            let enemy;
            let darts;
            var dartCount = 20;
            let fireKey;
            let cloudSpeed = 100;
            let enemyTicks = 0;
            let tickAmount = 1;
            let lifePoints = 3;
            let invincibility = false;
            let invinCount = 0;
            //Keyboard controls
            let cursors;
            let keys;
            let space;

            let gui;
            let guiTimer;

            function preload() {
                this.load.image("sky", "assets/clouds.png");
                this.load.image("platform", "assets/platform.png");
                this.load.atlas("cloudEnemy", "assets/Cloudsheet.png", "assets/Cloudsheet.json");
                this.load.atlas("meleeEnemy", "assets/Meleesheet.png", "assets/Meleesheet.json");
                this.load.atlas("player", "assets/playersheet.png", "assets/playersheet.json");
                this.load.atlas("batEnemy", "assets/Batsheet.png", "assets/Batsheet.json")
                this.load.atlas("rangedEnemy", "assets/Rangedsheet.png", "assets/Rangedsheet.json")
                this.load.atlas("cyclopsEnemy", "assets/Cyclopssheet.png", "assets/Cyclopssheet.json")
                this.load.image("chest_l", "assets/chest_states/chest_locked.png");
                this.load.image("chest_o", "assets/chest_states/chest_open.png");
                this.load.image("chest_ul", "assets/chest_states/chest_unlocked.png");
                this.load.image("dart", "assets/Darts/Dart_01.png");
            }

            function create() {
                //Set the background origin to be at (0, 0) or top left corner of the image rather than the center of the image asset
                let background = this.add.tileSprite(0, 0, game.scale.width, game.scale.height, "sky").setOrigin(0, 0);

                //create Chests
                chest1 = this.physics.add.sprite(400, 410, "chest_l");
                chest1.setCollideWorldBounds(false);
                chest1.body.setSize(30, 30);

                // Create darts group
                darts = this.physics.add.group({
                    maxSize: 10
                });

                //Create the platforms and the player character set to collide with the platforms
                createPlatforms(this);
                //creates an enemy

                enemy = new MeleeEnemy(this, 500, 450);
                enemy.setGravityY(0);

                //set up animations for player
                let playerAnimations = {};
                let idle = this.anims.create({
                    key: "sprite_idle",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_idle", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["idle"] = idle;
                let right = this.anims.create({
                    key: "sprite_right",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_right", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["right"] = right;
                let up = this.anims.create({
                    key: "sprite_jump",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_jump", end: 2, zeroPad: 1 }),
                    repeat: 1,
                    frameRate: 4
                });
                playerAnimations["up"] = up;
                let fall = this.anims.create({
                    key: "sprite_idle",
                    frames: this.anims.generateFrameNames("player", { prefix: "sprite_idle", end: 1, zeroPad: 1 }),
                    repeat: -1,
                    frameRate: 2
                });
                playerAnimations["fall"] = fall;

                //initialize player object w/ collision w platforms
                player = new Player(this, 800, 300, "player", playerAnimations);
                this.physics.add.collider(player, platforms);
                this.physics.add.collider(enemy, platforms);
                player.play(player.animations["idle"]);

                //Set up user input
                cursors = this.input.keyboard.createCursorKeys();
                keys = this.input.keyboard.addKeys("A, D");
                fireKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.F);
                space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                space.on("down", jump); //calls jump function when space is pressed

                gui = this.add.text(15, 15, "", { fontSize: "30px", fill: "#000000" });
                gui.setScrollFactor(0,0);
                enemy.setVelocityX(cloudSpeed);
                this.physics.add.overlap(player, enemy, dmgPlayer, null, this);
                this.physics.add.collider(enemy, darts, dmgEnemy);
                this.physics.add.overlap(enemy, darts, dmgEnemy);

                this.physics.add.collider(darts, platforms, dartPlatformCollision);
                this.physics.add.collider(chest1, platforms);
                this.physics.add.collider(chest1, darts, chestStateChange);

                //camera follow
                this.cameras.main.startFollow(player);
            }

            function createPlatforms(scene) {
                platforms = scene.physics.add.staticGroup();

                //all platforms
                platforms.create(500, 600, "platform").setScale(0.8).refreshBody();
                platforms.create(900, 540, "platform").setScale(0.8).refreshBody();
            }

            function update() {
                gui.setText("Health: " + lifePoints + " Darts : " + dartCount);

                basicEnemyMove(enemy, cloudSpeed, 101);
                
                //Player has "drag" on the x-axis meaning they slide a bit after an input
                player.setDragX(1000);
                if (player.y >= game.scale.height)
                    {
                        lifePoints = 0;
                    }
                if (player.body.touching.down && player.isJumping) {
                    player.isJumping = false;
                }

                //if player is jumping and velocity is 0, set to fall animation
                if (player.isJumping && player.body.velocity.y >= 0) {
                    player.play(player.animations["fall"], true);
                    console.log("done");
                }

                //Handle player movements
                if (cursors.left.isDown || keys.A.isDown) {
                    player.setVelocityX(-200);
                    player.flipX = true;
                    if (!player.isJumping) {
                        player.play(player.animations["right"], true);
                    }
                } else if (cursors.right.isDown || keys.D.isDown) {
                    player.setVelocityX(200);
                    player.flipX = false;
                    if (!player.isJumping) {
                        player.play(player.animations["right"], true);
                    }
                } else {
                    if (!player.isJumping) {
                        player.play(player.animations["idle"], true);
                    }
                }
                //If player is invincible, starts a countdown to when they will become vulnerable again
                if (invincibility) {
                    invinCount++;
                    if (invinCount === 75) {
                        invincibility = !invincibility;
                        invinCount = 0;
                    }
                }
                // Firing projectiles (darts)
                if (Phaser.Input.Keyboard.JustDown(fireKey) && dartCount > 0) {
                    firedart();
                    dartCount--;
                }
                // Check and destroy darts that have traveled roughly 600 pixels
                darts.children.each(function (dart) {
                    if (Math.abs(dart.x - dart.startX) > 600) {
                        destroy(dart);
                    }
                });
            }

            //change chest to unlocked state once hit by dart
            function chestStateChange(chest, dart) {
                chest1.setTexture("chest_ul");
                chest1.setVelocityX(0);
                chest1.setVelocityY(0);
                destroy(dart);
            }

            function jump(event) {
                if (player.body.touching.down) {
                    player.isJumping = true;
                    player.play(player.animations["up"], true);
                    player.setVelocityY(-700);
                }
            }

            //behavior of dart when fired
            function firedart() {
                let xOffset = 0;
                let dartDirection = 1; // 1 means normal direction, -1 means flipped direction

                if (player.flipX) {
                    xOffset = -20;
                    dartDirection = -1; // Flip the dart sprite
                } else {
                    xOffset = 20;
                    dartDirection = 1; // Normal direction
                }

                let dart = darts.get(player.x + xOffset, player.y);

                if (!dart) return;

                dart.setTexture("dart");
                dart.setScale(1.5);
                dart.setActive(true).setVisible(true);
                dart.setVelocityX(400 * dartDirection); // Adjust velocity based on dartDirection
                dart.setVelocityY(0); // Ensure vertical velocity is zero
                dart.allowGravity = false;
                dart.body.setAllowGravity(false); // Ensure physics body also disallows gravity
                dart.startX = dart.x;

                // Flip the dart sprite if necessary
                dart.setScale(dartDirection, 1.5); // Scale the dart sprite to flip it horizontally
            }

            //activated when dart collides with platform
            function dartPlatformCollision(dart, platform) {
                destroy(dart);
            }

            function dmgPlayer(player, source) {
                if (!invincibility) {
                    lifePoints--;
                    invincibility = !invincibility;
                }

                if (lifePoints === 0) {
                    player.disableBody(true, true);
                    this.add.text(200, 300, "GAME OVER", { fontSize: "100px", fill: "#ff0000" });
                    
                }
            }
            function dmgEnemy(enemy, source) {
                destroy(source);
                enemy.disableBody(true, true);
            }
            function basicEnemyMove(enemy, speed, length) {
                enemyTicks += tickAmount;
                if (enemyTicks === length) {
                    enemy.setVelocityX(-speed);
                    tickAmount = -1;
                    enemy.flipX = true;
                } else if (enemyTicks === -1) {
                    enemy.setVelocityX(speed);
                    tickAmount = 1;
                    enemy.flipX = false;
                }
            }
            

            //Reset the gui text to be empty after the guiTimer elapses
            function removeText() {
                gui.setText("");
            }

            //destroys object in parameter when called
            function destroy(destroyedObject) {
                destroyedObject.setVisible(false);
                destroyedObject.setActive(false);
            }
        </script>
    </body>
</html>
